{% extends 'base.html' %}
{% load static %}

{% block title %}{{ product.name }} - {{ product.category.name }} | GiftTree{% endblock %}

{% block meta_description %}{{ product.meta_description|default:product.description|truncatewords:30 }}{% endblock %}

{% block content %}
<!-- Mobile Header with Back Button -->
{% include 'includes/mobile_header.html' with show_back_button=True page_title="Product Details" show_share_button=True
%}

<!-- Product Gallery -->
<div class="product-gallery">
    <div class="main-image-container" id="mainImageContainer">
        {% if product.primary_image %}
        <img src="{{ product.primary_image.url }}" alt="{{ product.name }}" class="main-image" id="mainImage">
        {% else %}
        <img src="{% static 'images/products/rose.webp' %}" alt="{{ product.name }}" class="main-image" id="mainImage">
        {% endif %}

        <div class="gallery-badges">
            {% if product.is_featured %}
            <span class="badge">Featured</span>
            {% endif %}
            {% if product.is_bestseller %}
            <span class="badge">Bestseller</span>
            {% endif %}
            {% if product.is_in_stock %}
            <span class="badge new">Fresh</span>
            {% endif %}
        </div>

        <div class="gallery-actions">
            <button class="action-btn wishlist-btn" onclick="toggleWishlist()" id="wishlistBtn">
                <i class="far fa-heart" id="wishlistIcon"></i>
            </button>
            <button class="action-btn" onclick="shareProduct()">
                <i class="fas fa-share"></i>
            </button>
            <button class="action-btn" onclick="zoomImage()">
                <i class="fas fa-search-plus"></i>
            </button>
        </div>

        <div class="image-indicators">
            {% for image in product.all_images %}
            <span class="indicator {% if forloop.first %}active{% endif %}"
                onclick="changeMainImage(document.querySelectorAll('.thumbnail')[{{ forloop.counter0 }}], {{ forloop.counter0 }})"></span>
            {% endfor %}
        </div>
    </div>

    <div class="thumbnail-gallery">
        {% for image in product.all_images %}
        <img src="{{ image.image.url }}" alt="{{ image.alt_text|default:product.name }}"
            class="thumbnail {% if forloop.first %}active{% endif %}"
            onclick="changeMainImage(this, {{ forloop.counter0 }})">
        {% empty %}
        <img src="{% static 'images/products/rose.webp' %}" alt="{{ product.name }}" class="thumbnail active"
            onclick="changeMainImage(this, 0)">
        {% endfor %}
    </div>
</div>

<!-- Product Info -->
<div class="product-info">
    <h1 class="product-title">{{ product.name }}</h1>
    <p class="product-subtitle">{{ product.category.name }} - Fresh and premium quality</p>

    <div class="rating-section">
        <div class="rating-stars">
            {% comment %} Add rating display when review system is implemented {% endcomment %}
            <i class="fas fa-star star"></i>
            <i class="fas fa-star star"></i>
            <i class="fas fa-star star"></i>
            <i class="fas fa-star star"></i>
            <i class="fas fa-star star"></i>
        </div>
        <span class="rating-text">4.8 (124 reviews)</span>
        <a href="#reviews" class="reviews-link">See all reviews</a>
    </div>

    <div class="price-section">
        <span class="current-price">₹{{ product.current_price }}</span>
        {% if product.discount_price %}
        <span class="original-price">₹{{ product.base_price }}</span>
        <span class="discount-badge">{{ product.discount_percentage }}% OFF</span>
        <div class="savings-text">You save ₹{{
            product.base_price|floatformat:0|add:"-"|add:product.current_price|floatformat:0 }}</div>
        {% endif %}
    </div>
</div>

<!-- Product Options -->
<div class="product-options">
    {% if product.variants.all %}
    <div class="option-group">
        <h3 class="option-title">Choose Size</h3>
        <div class="size-options">
            {% for variant in product.variants.all %}
            <div class="size-option {% if forloop.first %}active{% endif %}"
                onclick="selectSize(this, {{ variant.final_price }})">
                <div class="size-name">{{ variant.name }}</div>
                <div class="size-price">₹{{ variant.final_price }}</div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% comment %} Add-ons section - implement when addon model is available {% endcomment %}
    <div class="option-group">
        <h3 class="option-title">Add-ons (Optional)</h3>
        <div class="addon-options">
            <div class="addon-item" onclick="toggleAddon(this, 299)">
                <input type="checkbox" class="addon-checkbox">
                <img src="{% static 'images/products/chocko cake.jpg' %}" alt="Chocolate Cake" class="addon-image">
                <div class="addon-details">
                    <div class="addon-name">Chocolate Cake (500g)</div>
                    <div class="addon-price">+ ₹299</div>
                </div>
            </div>
            <div class="addon-item" onclick="toggleAddon(this, 199)">
                <input type="checkbox" class="addon-checkbox">
                <img src="{% static 'images/products/teddy.webp' %}" alt="Teddy Bear" class="addon-image">
                <div class="addon-details">
                    <div class="addon-name">Cute Teddy Bear</div>
                    <div class="addon-price">+ ₹199</div>
                </div>
            </div>
            <div class="addon-item" onclick="toggleAddon(this, 149)">
                <input type="checkbox" class="addon-checkbox">
                <img src="{% static 'images/products/default.jpg' %}" alt="Greeting Card" class="addon-image">
                <div class="addon-details">
                    <div class="addon-name">Personalized Card</div>
                    <div class="addon-price">+ ₹149</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delivery Info -->
<div class="delivery-info">
    <h3 class="delivery-title">Delivery Options</h3>
    <div class="delivery-options">
        <div class="delivery-option selected" onclick="selectDelivery(this)">
            <input type="radio" name="delivery" class="delivery-radio" checked>
            <div class="delivery-icon">
                <i class="fas fa-shipping-fast"></i>
            </div>
            <div class="delivery-details">
                <div class="delivery-name">Same Day Delivery</div>
                <div class="delivery-time">Within 3-6 hours</div>
            </div>
            <div class="delivery-price free-delivery">FREE</div>
        </div>
        <div class="delivery-option" onclick="selectDelivery(this)">
            <input type="radio" name="delivery" class="delivery-radio">
            <div class="delivery-icon">
                <i class="fas fa-moon"></i>
            </div>
            <div class="delivery-details">
                <div class="delivery-name">Midnight Delivery</div>
                <div class="delivery-time">12:00 AM - 12:30 AM</div>
            </div>
            <div class="delivery-price">₹99</div>
        </div>
        <div class="delivery-option" onclick="selectDelivery(this)">
            <input type="radio" name="delivery" class="delivery-radio">
            <div class="delivery-icon">
                <i class="fas fa-clock"></i>
            </div>
            <div class="delivery-details">
                <div class="delivery-name">Fixed Time Delivery</div>
                <div class="delivery-time">Choose your preferred slot</div>
            </div>
            <div class="delivery-price">₹49</div>
        </div>
    </div>
</div>

<!-- Product Description -->
<div class="product-description">
    <h3 class="description-title">Product Description</h3>
    <div class="description-text">
        {{ product.description|linebreaks }}
    </div>

    {% if product.care_instructions %}
    <h4>Care Instructions</h4>
    <div class="description-text">
        {{ product.care_instructions|linebreaks }}
    </div>
    {% endif %}

    <ul class="features-list">
        <li><i class="fas fa-check"></i> Fresh and premium quality</li>
        <li><i class="fas fa-check"></i> Same day delivery available</li>
        <li><i class="fas fa-check"></i> Handpicked by expert florists</li>
        <li><i class="fas fa-check"></i> 100% satisfaction guarantee</li>
        {% if product.is_in_stock %}
        <li><i class="fas fa-check"></i> In stock and ready to ship</li>
        {% endif %}
    </ul>
</div>

<!-- Similar Products -->
{% if related_products %}
<div class="similar-products">
    <h3 class="similar-title">Similar Products</h3>
    <div class="similar-scroll">
        <div class="similar-row">
            {% for related_product in related_products %}
            <div class="similar-card" onclick="window.location.href='{{ related_product.get_absolute_url }}'">
                {% if related_product.primary_image %}
                <img src="{{ related_product.primary_image.url }}" alt="{{ related_product.name }}"
                    class="similar-image">
                {% else %}
                <img src="{% static 'images/products/default.jpg' %}" alt="{{ related_product.name }}"
                    class="similar-image">
                {% endif %}
                <div class="similar-info">
                    <div class="similar-name">{{ related_product.name|truncatechars:20 }}</div>
                    <div class="similar-price">₹{{ related_product.current_price }}</div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Reviews Section -->
<div class="reviews-section" id="reviews">
    <div class="reviews-header">
        <h3 class="reviews-title">Customer Reviews</h3>
        <a href="#" class="view-all-reviews">View all reviews</a>
    </div>

    <div class="review-summary">
        <div class="review-score">
            <div class="score-number">4.8</div>
            <div class="score-stars">
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
            </div>
            <div class="score-text">124 reviews</div>
        </div>

        <div class="review-bars">
            <div class="review-bar">
                <span class="bar-label">5</span>
                <div class="bar-track">
                    <div class="bar-fill" style="width: 80%"></div>
                </div>
                <span class="bar-count">99</span>
            </div>
            <div class="review-bar">
                <span class="bar-label">4</span>
                <div class="bar-track">
                    <div class="bar-fill" style="width: 15%"></div>
                </div>
                <span class="bar-count">19</span>
            </div>
            <div class="review-bar">
                <span class="bar-label">3</span>
                <div class="bar-track">
                    <div class="bar-fill" style="width: 3%"></div>
                </div>
                <span class="bar-count">4</span>
            </div>
            <div class="review-bar">
                <span class="bar-label">2</span>
                <div class="bar-track">
                    <div class="bar-fill" style="width: 1%"></div>
                </div>
                <span class="bar-count">1</span>
            </div>
            <div class="review-bar">
                <span class="bar-label">1</span>
                <div class="bar-track">
                    <div class="bar-fill" style="width: 1%"></div>
                </div>
                <span class="bar-count">1</span>
            </div>
        </div>
    </div>

    <!-- Sample Reviews -->
    <div class="review-item">
        <div class="review-header">
            <div class="reviewer-avatar">A</div>
            <div class="reviewer-info">
                <div class="reviewer-name">Anita Sharma</div>
                <div class="review-date">2 days ago</div>
            </div>
            <div class="review-rating">
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
            </div>
        </div>
        <div class="review-text">
            Beautiful roses! They were fresh and lasted for more than a week. The delivery was on time and the packaging
            was excellent. Highly recommended!
        </div>
    </div>

    <div class="review-item">
        <div class="review-header">
            <div class="reviewer-avatar">R</div>
            <div class="reviewer-info">
                <div class="reviewer-name">Rajesh Kumar</div>
                <div class="review-date">1 week ago</div>
            </div>
            <div class="review-rating">
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
            </div>
        </div>
        <div class="review-text">
            Perfect for anniversary! My wife loved the bouquet. The quality was amazing and the delivery was exactly on
            time.
        </div>
    </div>
</div>

<!-- Sticky Bottom Bar -->
<div class="sticky-bottom">
    <div class="bottom-actions">
        <div class="quantity-selector">
            <button class="qty-btn" onclick="changeQuantity(-1)">
                <i class="fas fa-minus"></i>
            </button>
            <input type="number" class="qty-input" id="quantity" value="1" min="1" max="10" readonly>
            <button class="qty-btn" onclick="changeQuantity(1)">
                <i class="fas fa-plus"></i>
            </button>
        </div>

        <button class="add-to-cart-btn" onclick="addProductToCart()" id="addToCartBtn">
            ADD TO CART - ₹<span id="totalPrice">{{ product.current_price }}</span>
        </button>

        <button class="wishlist-toggle" onclick="toggleWishlist()" id="wishlistToggle">
            <i class="far fa-heart"></i>
        </button>
    </div>
</div>

<!-- Toast Notification -->
<div class="toast" id="toast"></div>
{% endblock %}

{% block extra_css %}
<style>
    /* Product detail specific styles */
    .product-gallery {
        background: white;
        position: relative;
    }

    .main-image-container {
        position: relative;
        height: 350px;
        overflow: hidden;
    }

    .main-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
    }

    .gallery-badges {
        position: absolute;
        top: 16px;
        left: 16px;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .gallery-actions {
        position: absolute;
        top: 16px;
        right: 16px;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .action-btn {
        background: rgba(255, 255, 255, 0.9);
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-dark);
        font-size: 16px;
        transition: all 0.3s;
        backdrop-filter: blur(10px);
        cursor: pointer;
    }

    .action-btn.active {
        background: var(--primary-color);
        color: white;
    }

    .image-indicators {
        position: absolute;
        bottom: 16px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 8px;
    }

    .indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.5);
        transition: all 0.3s;
        cursor: pointer;
    }

    .indicator.active {
        background: white;
        width: 24px;
        border-radius: 4px;
    }

    .thumbnail-gallery {
        display: flex;
        gap: 8px;
        padding: 12px 16px;
        overflow-x: auto;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }

    .thumbnail-gallery::-webkit-scrollbar {
        display: none;
    }

    .thumbnail {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        object-fit: cover;
        border: 2px solid transparent;
        transition: all 0.3s;
        flex-shrink: 0;
        cursor: pointer;
    }

    .thumbnail.active {
        border-color: var(--primary-color);
    }

    /* Desktop adjustments */
    @media (min-width: 992px) {
        .main-image-container {
            height: 500px;
        }

        .product-info,
        .product-options,
        .delivery-info,
        .product-description,
        .similar-products,
        .reviews-section {
            padding: 30px 40px;
        }

        .sticky-bottom {
            display: none;
        }

        .similar-card {
            width: 180px;
        }

        .similar-image {
            height: 180px;
        }
    }
</style>
{% endblock %}

{% block page_js %}
<script src="{% static 'js/product.js' %}"></script>
<script>
    // Product detail specific JavaScript
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize product price
        const basePrice = {{ product.current_price }
    };
    window.currentPrice = basePrice;

    // Set product data for cart
    window.productData = {
        id: {{ product.id }},
    name: "{{ product.name|escapejs }}",
        price: basePrice,
            image: "{% if product.primary_image %}{{ product.primary_image.url }}{% else %}{% static 'images/products/default.jpg' %}{% endif %}",
                category: "{{ product.category.name|escapejs }}"
    };

    // Initialize quantity
    window.quantity = 1;

    // Update total price display
    updateTotalPrice();
});

    // Override the addProductToCart function for this page
    function addProductToCart() {
        const cartItem = {
            id: window.productData.id,
            name: window.productData.name,
            price: window.currentPrice,
            quantity: window.quantity,
            addons: window.selectedAddons || [],
            image: window.productData.image,
            total: (window.currentPrice + (window.selectedAddons ? window.selectedAddons.reduce((sum, addon) => sum + addon.price, 0) : 0)) * window.quantity
        };

        // Add to cart (if cart.js is loaded)
        if (typeof addItemToCart === 'function') {
            addItemToCart(cartItem);
        } else {
            // Fallback
            showToast(`${cartItem.name} added to cart! Total: ₹${cartItem.total}`);

            // Update cart badge
            const cartBadges = document.querySelectorAll('.cart-badge, .cart-count');
            cartBadges.forEach(badge => {
                const currentCount = parseInt(badge.textContent) || 0;
                badge.textContent = currentCount + cartItem.quantity;
            });
        }

        // Haptic feedback
        if (navigator.vibrate) {
            navigator.vibrate([50, 50, 50]);
        }

        // Add loading state to button
        const addToCartBtn = document.getElementById('addToCartBtn');
        if (addToCartBtn) {
            addToCartBtn.disabled = true;
            addToCartBtn.innerHTML = 'Adding... <div class="loading"></div>';

            setTimeout(() => {
                addToCartBtn.disabled = false;
                addToCartBtn.innerHTML = `ADD TO CART - ₹<span id="totalPrice">${(window.currentPrice + (window.selectedAddons ? window.selectedAddons.reduce((sum, addon) => sum + addon.price, 0) : 0)) * window.quantity}</span>`;
            }, 1000);
        }
    }
</script>
{% endblock %}